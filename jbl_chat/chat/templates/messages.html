{% extends "base.html" %}

{% block title %}Messages{% endblock %}

{% block head_extra %}
<script>
  const userId = {{ user_id }};
  const otherUserId = {{ other_user_id }};
  const userFullname = "{{ user_fullname }}";
  const otherUserFullname = "{{ other_user_fullname }}";
</script>
{% endblock %}

{% block content %}
<a href="/users/{{ user_id }}/" style="display: inline-block; margin-bottom: 1rem;">Users</a>

<h2>Messages</h2>
<div id="error"></div>
<table id="messages-table">
  <thead>
    <tr>
      <th>ID</th>
      <th>Content</th>
      <th>Sender</th>
      <th>Recipient</th>
      <th>Created At</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
{% endblock %}

{% block scripts %}
<script>
  (function() {
    const endpoint = `/api/messages/${userId}/${otherUserId}/`;

    const tableBody = document.querySelector('#messages-table tbody');
    const errorDiv = document.getElementById('error');

    fetch(endpoint)
      .then(response => {
        if (!response.ok) {
          return response.json().then(err => {
            throw new Error(err.error || 'Failed to fetch messages');
          });
        }
        return response.json();
      })
      .then(json => {
        const messages = json.data || [];
        if (messages.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="5">No messages found.</td></tr>';
          return;
        }
        tableBody.innerHTML = messages.map(msg => `
          <tr>
            <td>${msg.id}</td>
            <td>${msg.content}</td>
            <td>${msg.sender_id === userId ? userFullname : otherUserFullname}</td>
            <td>${msg.recipient_id === userId ? userFullname : otherUserFullname}</td>
            <td>${new Date(msg.created_at).toLocaleString()}</td>
          </tr>
        `).join('');
      })
      .catch(err => {
        errorDiv.textContent = err.message;
        tableBody.innerHTML = '';
      });
  })();
</script>
{% endblock %}
